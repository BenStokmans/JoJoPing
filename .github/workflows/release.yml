name: Build, Test and Release JoJoPing

on:
    push:
        branches:
            - main

jobs:
    build-and-test:
        name: Build Swift App and Raycast Extension
        runs-on: macos-15
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Xcode
              uses: maxim-lobanov/setup-xcode@v1
              with:
                  xcode-version: latest-stable

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'
                  cache-dependency-path: 'jojoping-raycast/pnpm-lock.yaml'

            - name: Install Raycast Extension Dependencies
              working-directory: jojoping-raycast
              run: pnpm install --frozen-lockfile

            - name: Build Swift App
              run: |
                  xcodebuild -project JoJoPing.xcodeproj \
                    -scheme JoJoPing \
                    -configuration Release \
                    -archivePath build/JoJoPing.xcarchive \
                    archive

            - name: Export App
              run: |
                  xcodebuild -exportArchive \
                    -archivePath build/JoJoPing.xcarchive \
                    -exportPath build/Release \
                    -exportOptionsPlist scripts/ExportOptions.plist || \
                  xcodebuild -exportArchive \
                    -archivePath build/JoJoPing.xcarchive \
                    -exportPath build/Release \
                    -exportFormat app

            - name: Build Raycast Extension
              working-directory: jojoping-raycast
              run: pnpm run build

            - name: Upload Swift App as Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: jojoping-app
                  path: build/Release/

            - name: Upload Raycast Extension as Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: raycast-extension
                  path: jojoping-raycast/dist/

    create-release:
        name: Create release
        needs: build-and-test
        runs-on: ubuntu-latest
        permissions:
            contents: write           # To be able to publish a GitHub Release
            issues: write             # To be able to comment on related issues
            pull-requests: write      # To be able to comment on released pull requests
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'pnpm'

            - name: Install Dependencies
              run: pnpm install --ignore-scripts

            - name: Configure Git user
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"

            - name: Create and Publish Release
              id: create-release
              run: pnpm run release
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    upload-dmg:
        name: Upload DMG to GitHub Release
        needs: create-release
        runs-on: macos-15
        permissions: write-all
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Retrieve Swift App from artifact
              uses: actions/download-artifact@v4
              with:
                  name: jojoping-app
                  path: build/Release/

            - name: Get Latest Tag
              id: previoustag
              uses: WyriHaximus/github-action-get-previous-tag@v1.4.0
              with:
                  fallback: v1.0.0

            - name: Create DMG
              run: |
                  chmod +x scripts/create-dmg.sh
                  scripts/create-dmg.sh

            - name: Upload DMG to release
              uses: softprops/action-gh-release@v2
              with:
                  files: build/*.dmg
                  token: ${{ secrets.GITHUB_TOKEN }}
                  tag_name: ${{ steps.previoustag.outputs.tag }}
                  append_body: true

    upload-raycast-extension:
        name: Upload Raycast Extension to GitHub Release
        needs: create-release
        runs-on: ubuntu-latest
        permissions: write-all
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Retrieve Raycast Extension from artifact
              uses: actions/download-artifact@v4
              with:
                  name: raycast-extension
                  path: raycast-dist/

            - name: Get Latest Tag
              id: previoustag
              uses: WyriHaximus/github-action-get-previous-tag@v1.4.0
              with:
                  fallback: v1.0.0

            - name: Create Raycast Extension ZIP
              run: |
                  cd raycast-dist
                  zip -r ../jojoping-raycast-${{ steps.previoustag.outputs.tag }}.zip .

            - name: Upload Raycast Extension to release
              uses: softprops/action-gh-release@v2
              with:
                  files: jojoping-raycast-${{ steps.previoustag.outputs.tag }}.zip
                  token: ${{ secrets.GITHUB_TOKEN }}
                  tag_name: ${{ steps.previoustag.outputs.tag }}
                  append_body: true
